<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=, initial-scale=1.0">
    <link rel="stylesheet" href="/static/css/profile.css"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>    
    <title>Document</title>
</head>
<body>
    <div class="nav">
        <a href="/" style="text-decoration: none;"><h1 class="head">ProPySolver</h1></a>
        <button class="btn btn-primary" onclick="window.location.href='/logout/'">Logout</button>
    </div>
    <div class="main row">
        <div class="left col-md-9">
            <div class="top">
                <div class="card card1 profile">
                    <img src="https://res.cloudinary.com/dhva31opb/image/upload/v1686761113/default_profile_qv3rku.jpg" class="img"/>
                    <h3>{{user.username}}</h3>
                    <p>{{user.email}}</p>
                </div>
                <div class="card card1 bargraph">
                    <canvas id="myBarChart"></canvas>
                </div>
            </div>
            <div class="card bottom"  styel="white-space: pre-wrap; word-wrap: break-word;"id="advice-box">
                <div class="advice">
                    <h1>Advice for imporovement:</h1>
                    <button class="btn btn-primary" id="advice-button" onclick="getAdvice()">Get Advice</button>
                </div>
            </div>
        </div>
        <div class="right col-md-3">
            <div class="card status">
                <div class="percentage">
                    <p>No of problems solved</p>
                    <h1 style="color: #8353E2FF;">{{overall_percentage}}%</h1>
                    <p class="value">{{accepted}}/{{noof_problems}}</p>
                </div>
                <div class="doughnut">
                    <canvas id="myDoughnutChart"></canvas>
                </div>
            </div>
            <div class="card bar">
                {%  for module in module_count %}
                <h1>{{module.0}}</h1>
                <div class="progress mt-3" role="progressbar" aria-label="Example with label" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">
                    <div class="progress-bar" style="width: {{module.2}}%;background-color: #8353E2FF;">{{module.2}}%</div>
                </div>
                {%  endfor %}
            </div>
        </div>
    </div>
    <script>
        const ctx = document.getElementById('myBarChart').getContext('2d');
        const myBarChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Two Pointer ', 'Greedy', 'Math', 'Binary Search', 'DP', 'Divide and Conquer', 'Sorting', 'Data Structures'],
                datasets: [{
                    label: 'Number of Problems Solved',
                    data:['{{ tag_count.0}}', '{{ tag_count.1}}', '{{ tag_count.2}}', '{{ tag_count.3}}', '{{ tag_count.4}}', '{{ tag_count.5}}', '{{ tag_count.6}}', '{{ tag_count.7 }}'], 
                    backgroundColor: [
                    'rgb(131,83,226)',
                    'rgb(131,83,226)',
                    'rgb(131,83,226)',
                    'rgb(131,83,226)',
                    'rgb(131,83,226)',
                    'rgb(131,83,226)',
                    'rgb(131,83,226)',
                    'rgb(131,83,226)'
                    ],
                    borderColor: [
                        'rgba(131, 83, 226, 1)',
                        'rgba(131, 83, 226, 1)',
                        'rgba(131, 83, 226, 1)',
                        'rgba(131, 83, 226, 1)',
                        'rgba(131, 83, 226, 1)',
                        'rgba(131, 83, 226, 1)',
                        'rgba(131, 83, 226, 1)',
                        'rgba(131, 83, 226, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    x: {
                        ticks: {
                            maxRotation: 0, 
                            minRotation: 0,
                            autoSkip: false  
                        },
                    },
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
        const ctxDoughnut = document.getElementById('myDoughnutChart').getContext('2d');
        const myDoughnutChart = new Chart(ctxDoughnut, {
            type: 'doughnut',
            data: {
                labels: ['Not Attempted', 'Solved', 'WrongAnswer'],
                datasets: [{
                    label: 'Problems Solved',
                    data: [{{ not_attempted }}, {{accepted}}, {{ wrong_answers }}], 
                    backgroundColor: [
                        'gray',
                        'rgb(177, 239, 84)',
                        'rgb(234, 65, 65)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: false,
                plugins: {
                    legend: {
                        display:false,
                    },
                    tooltip: {
                        callbacks: {
                            label: function(tooltipItem) {
                                const value = tooltipItem.raw;
                                const label = tooltipItem.label;
                                return `${label}: ${value}`;
                            }
                        }
                    }
                }
            }
        });
    </script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/typewriter-effect@latest/dist/core.js"></script>
    <script>
        function applyTypewriterEffect(container, text) {
            var typewriter = new Typewriter(container, {
                loop: false,
                delay: 10,
            });
            typewriter
                .typeString(text)
                .start()

        }
        function getAdvice() {
            var spinner  = '<div class="spinner-border text-light" role="status"><span class="sr-only"></span></div>'
            $("#advice-button").html(spinner);
            $.ajax({
                url: '/advice/',
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{csrf_token}}'
                },
                data: {
                    
                },
                success: function (data) {
                    console.log('Advice:', data);
                    var text = data['response'];
                    var advice_box = document.getElementById('advice-box');
                    var pre = document.createElement('pre');
                    var formattedText = text.replace( /"([^"]+)"/g,"<strong>$1</strong>")
                                            .replace(/(\*\*(.+?)\*\*)/g, "<strong>$2</strong>");
                    formattedText = formattedText
                    pre.style.whiteSpace = 'pre-wrap';
                    advice_box.appendChild(pre);
                    pre.innerHTML
                    applyTypewriterEffect(pre, formattedText);

                    $("#advice-button").text("Get Advice");
                },
                error: function (xhr, status, error) {
                    console.error('Error sending code:', error);
                }
            });
        }
    </script>
</body>
</html>
